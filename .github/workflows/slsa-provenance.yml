---
name: SLSA Provenance & Supply Chain Attestation

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# Global permissions (minimal)
permissions:
  contents: read

env:
  # SLSA provenance level - 2025 best practice is SLSA 3
  SLSA_LEVEL: 3

jobs:
  # Build artifacts with provenance
  build:
    name: Build with SLSA Provenance
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    permissions:
      contents: read
      id-token: write  # Required for SLSA provenance
      packages: write  # For publishing artifacts
      attestations: write  # For build attestations

    outputs:
      artifact-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            registry.npmjs.org:443
            nodejs.org:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Checkout repository
        uses: actions/checkout@v5.2.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5.1.0
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # Build the project
      - name: Install dependencies
        run: |
          npm ci --audit=false

      - name: Build project
        id: build
        run: |
          # Add your build commands here
          echo "Building project..."
          # Example: npm run build

          # Create a tarball of the build output
          mkdir -p dist
          tar -czf dist/build-artifacts.tar.gz .

          # Calculate digest for attestation
          DIGEST=$(sha256sum dist/build-artifacts.tar.gz | awk '{print $1}')
          echo "digest=sha256:$DIGEST" >> $GITHUB_OUTPUT
          echo "Build artifact digest: $DIGEST"

      # Generate attestation for build artifacts
      - name: Generate Build Attestation
        uses: actions/attest-build-provenance@v2.1.0
        with:
          subject-path: 'dist/build-artifacts.tar.gz'

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: build-artifacts-with-attestation
          path: dist/
          retention-days: 90
          attestation: true

  # SLSA Provenance Generation (Level 3)
  provenance:
    name: Generate SLSA3 Provenance
    needs: [build]
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: read
      id-token: write
      actions: read
      packages: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: build-artifacts-with-attestation
          path: dist/

      # Generate SLSA provenance using official generator
      - name: Generate SLSA Provenance
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
        with:
          base64-subjects: ${{ needs.build.outputs.artifact-digest }}
          upload-assets: true
          provenance-name: provenance.intoto.jsonl

      - name: Upload SLSA Provenance
        uses: actions/upload-artifact@v4.5.0
        with:
          name: slsa-provenance
          path: provenance.intoto.jsonl
          retention-days: 365  # Keep provenance for 1 year
          attestation: true

  # Verify SLSA provenance
  verify:
    name: Verify SLSA Provenance
    needs: [build, provenance]
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Download Artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: build-artifacts-with-attestation
          path: dist/

      - name: Download Provenance
        uses: actions/download-artifact@v4.1.8
        with:
          name: slsa-provenance
          path: provenance/

      # Install SLSA verifier
      - name: Install SLSA Verifier
        run: |
          wget https://github.com/slsa-framework/slsa-verifier/releases/download/v2.6.0/slsa-verifier-linux-amd64
          chmod +x slsa-verifier-linux-amd64
          sudo mv slsa-verifier-linux-amd64 /usr/local/bin/slsa-verifier

      - name: Verify SLSA Provenance
        run: |
          echo "## ðŸ” SLSA Provenance Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify the provenance
          if slsa-verifier verify-artifact dist/build-artifacts.tar.gz \
            --provenance-path provenance/provenance.intoto.jsonl \
            --source-uri github.com/${{ github.repository }}; then
            echo "âœ… SLSA provenance verification **PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Provenance Signature | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
            echo "| Source Repository | âœ… Matched |" >> $GITHUB_STEP_SUMMARY
            echo "| Build Integrity | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
            echo "| SLSA Level | 3 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ SLSA provenance verification **FAILED**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Sigstore signing with Cosign
  sign:
    name: Sign Artifacts with Sigstore
    needs: [build, verify]
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write
      packages: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: Download Artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: build-artifacts-with-attestation
          path: dist/

      # Sign artifacts using keyless signing (OIDC)
      - name: Sign Artifacts with Cosign
        run: |
          echo "Signing artifacts with Sigstore Cosign..."
          cosign sign-blob \
            --yes \
            --bundle dist/build-artifacts.tar.gz.bundle \
            dist/build-artifacts.tar.gz

          echo "âœ… Artifacts signed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Signature bundle: build-artifacts.tar.gz.bundle" >> $GITHUB_STEP_SUMMARY

      - name: Upload Signed Artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: signed-artifacts
          path: dist/
          retention-days: 365
          attestation: true

      - name: Generate Supply Chain Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Supply Chain Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SLSA Provenance | âœ… Level 3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Attestation | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| Sigstore Signature | âœ… Signed |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact Digest | ${{ needs.build.outputs.artifact-digest }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- Keyless signing with OIDC" >> $GITHUB_STEP_SUMMARY
          echo "- Transparency log via Rekor" >> $GITHUB_STEP_SUMMARY
          echo "- Build provenance attestation" >> $GITHUB_STEP_SUMMARY
          echo "- SHA-256 artifact verification" >> $GITHUB_STEP_SUMMARY
