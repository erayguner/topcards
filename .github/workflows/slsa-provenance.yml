---
name: SLSA Provenance & Supply Chain Attestation

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# Global permissions (minimal)
permissions:
  contents: read

env:
  # SLSA provenance level - 2025 best practice is SLSA 3
  SLSA_LEVEL: 3

jobs:
  # Build artifacts with provenance
  build:
    name: Build with SLSA Provenance
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    permissions:
      contents: read
      id-token: write  # Required for SLSA provenance
      packages: write  # For publishing artifacts
      attestations: write  # For build attestations

    outputs:
      artifact-digest: ${{ steps.hash.outputs.digest }}
      artifact-name: ${{ steps.upload.outputs.artifact-name }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            registry.npmjs.org:443
            nodejs.org:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # Build the project
      - name: Install dependencies
        run: |
          npm ci --audit=false || echo "No package.json found"

      - name: Build project
        id: build
        run: |
          # Add your build commands here
          echo "Building project..."
          # Example: npm run build

          # Create a tarball of the build output
          mkdir -p dist
          tar -czf dist/build-artifacts.tar.gz .

      - name: Generate artifact hash
        id: hash
        run: |
          # Calculate digest for attestation
          DIGEST=$(sha256sum dist/build-artifacts.tar.gz | awk '{print $1}')
          echo "digest=sha256:$DIGEST" >> $GITHUB_OUTPUT
          echo "Build artifact digest: $DIGEST"

      # Generate attestation for build artifacts using GitHub's native attestation
      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2.0.0
        if: github.event_name != 'pull_request'
        with:
          subject-path: 'dist/build-artifacts.tar.gz'

      - name: Upload Build Artifacts
        id: upload
        uses: actions/upload-artifact@v4.4.3
        with:
          name: build-artifacts-with-attestation
          path: dist/
          retention-days: 90
          if-no-files-found: warn

  # Sigstore signing with Cosign
  sign:
    name: Sign Artifacts with Sigstore
    needs: [build]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write
      packages: write
      attestations: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443
            storage.googleapis.com:443

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0
        with:
          cosign-release: 'v2.4.1'

      - name: Download Artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: build-artifacts-with-attestation
          path: dist/

      # Sign artifacts using keyless signing (OIDC)
      - name: Sign Artifacts with Cosign
        run: |
          echo "Signing artifacts with Sigstore Cosign..."
          cosign sign-blob \
            --yes \
            --bundle dist/build-artifacts.tar.gz.bundle \
            dist/build-artifacts.tar.gz

          echo "âœ… Artifacts signed successfully"

      - name: Upload Signed Artifacts
        uses: actions/upload-artifact@v4.4.3
        with:
          name: signed-artifacts
          path: dist/
          retention-days: 365
          if-no-files-found: warn

      - name: Generate Supply Chain Summary
        run: |
          echo "## ðŸ“‹ Supply Chain Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SLSA Provenance | âœ… Level 3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Attestation | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| Sigstore Signature | âœ… Signed |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact Digest | ${{ needs.build.outputs.artifact-digest }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- Keyless signing with OIDC" >> $GITHUB_STEP_SUMMARY
          echo "- Transparency log via Rekor" >> $GITHUB_STEP_SUMMARY
          echo "- Build provenance attestation" >> $GITHUB_STEP_SUMMARY
          echo "- SHA-256 artifact verification" >> $GITHUB_STEP_SUMMARY
