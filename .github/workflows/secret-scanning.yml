---
name: Advanced Secret Scanning & Credential Detection

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run comprehensive secret scan daily at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'Scan depth (commits to scan)'
        required: false
        default: '100'
        type: choice
        options:
          - '10'
          - '50'
          - '100'
          - 'all'

# Global permissions (minimal)
permissions:
  contents: read

env:
  SCAN_DEPTH: ${{ github.event.inputs.scan_depth || '100' }}

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            objects.githubusercontent.com:443
            *.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
          persist-credentials: false

      # Gitleaks - Industry standard secret scanner
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks+ features
          GITLEAKS_ENABLE_COMMENTS: true

      - name: Upload Gitleaks Results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: gitleaks-results
          path: gitleaks-report.sarif
          retention-days: 90
          if-no-files-found: warn
          attestation: true

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            uploads.github.com:443
            objects.githubusercontent.com:443
            *.githubusercontent.com:443
            ghcr.io:443
            *.ghcr.io:443
            pkg-containers.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: false

      # TruffleHog - Finds verified secrets with active scanning
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@v3.82.13
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --json --fail

      - name: Upload TruffleHog Results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: trufflehog-results
          path: trufflehog-report.json
          retention-days: 90
          if-no-files-found: ignore
          attestation: true

  detect-secrets:
    name: Yelp Detect-Secrets Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            pypi.org:443
            files.pythonhosted.org:443
            objects.githubusercontent.com:443
            *.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '3.12'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          detect-secrets scan --all-files \
            --exclude-files '\.git/.*' \
            --exclude-files 'node_modules/.*' \
            --exclude-files 'package-lock\.json' \
            > detect-secrets-results.json || true

      - name: Audit detect-secrets results
        run: |
          if [ -f detect-secrets-results.json ]; then
            # Check if any secrets were found
            SECRET_COUNT=$(cat detect-secrets-results.json | python3 -c "import sys, json; data = json.load(sys.stdin); print(sum(len(v) for v in data.get('results', {}).values()))")

            echo "## ðŸ” Detect-Secrets Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Secrets found: **$SECRET_COUNT**" >> $GITHUB_STEP_SUMMARY

            if [ "$SECRET_COUNT" -gt 0 ]; then
              echo "âš ï¸ **WARNING**: Potential secrets detected in the repository!" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload detect-secrets results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: detect-secrets-results
          path: detect-secrets-results.json
          retention-days: 90
          if-no-files-found: warn
          attestation: true

  credential-digger:
    name: SAP Credential Digger ML Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 25

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            pypi.org:443
            files.pythonhosted.org:443
            objects.githubusercontent.com:443
            *.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '3.11'

      - name: Install Credential Digger
        run: |
          pip install credentialdigger

      - name: Run Credential Digger
        run: |
          # Create SQLite database for results
          credentialdigger scan path . --sqlite credential-results.db || true

          # Export results to JSON
          credentialdigger export --sqlite credential-results.db --output credential-digger-results.json || true

      - name: Upload Credential Digger results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: credential-digger-results
          path: |
            credential-digger-results.json
            credential-results.db
          retention-days: 90
          if-no-files-found: ignore
          attestation: true

  secret-scan-summary:
    name: Consolidated Secret Scan Report
    needs: [gitleaks, trufflehog, detect-secrets, credential-digger]
    runs-on: ubuntu-24.04
    if: always()
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.12.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Download all scan results
        uses: actions/download-artifact@v4.1.8
        with:
          path: scan-results/

      - name: Generate Consolidated Report
        run: |
          echo "## ðŸ” Secret Scanning Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ›¡ï¸ Security Scanning Tools Used" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Results |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Check each tool's results
          if [ -d "scan-results/gitleaks-results" ]; then
            echo "| ðŸ” Gitleaks | âœ… Completed | Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Gitleaks | âš ï¸ No results | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "scan-results/trufflehog-results" ]; then
            echo "| ðŸ· TruffleHog | âœ… Completed | Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ· TruffleHog | âš ï¸ No results | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "scan-results/detect-secrets-results" ]; then
            echo "| ðŸ”Ž Detect-Secrets | âœ… Completed | Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”Ž Detect-Secrets | âš ï¸ No results | - |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "scan-results/credential-digger-results" ]; then
            echo "| ðŸ¤– Credential Digger (ML) | âœ… Completed | Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ¤– Credential Digger (ML) | âš ï¸ No results | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Scan Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Depth:** ${{ env.SCAN_DEPTH }} commits" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Type:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Full History:** Yes (fetch-depth: 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Multi-tool scanning for comprehensive coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ML-based detection (Credential Digger)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Active secret verification (TruffleHog)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Historical commit scanning" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SARIF format for GitHub Security integration" >> $GITHUB_STEP_SUMMARY

      - name: Create combined report artifact
        run: |
          mkdir -p combined-report
          echo "Secret Scanning Completed - $(date -u)" > combined-report/summary.txt
          echo "See artifacts for detailed results" >> combined-report/summary.txt

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4.4.3
        with:
          name: secret-scan-combined-report
          path: combined-report/
          retention-days: 365
          attestation: true
