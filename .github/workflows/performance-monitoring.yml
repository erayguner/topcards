---
name: Performance Monitoring & Optimization

on:
  workflow_run:
    workflows: ["CodeQL Security Analysis", "MegaLinter Security & Quality Scan"]
    types: [completed]
  schedule:
    # Run weekly performance analysis on Fridays at 8 AM UTC
    - cron: '0 8 * * 5'
  workflow_dispatch:

# Global permissions (minimal)
permissions:
  contents: read

jobs:
  workflow-performance:
    name: Workflow Performance Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: read
      actions: read
      metadata: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Analyze Workflow Performance
        id: performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get workflow runs from the last 30 days
          echo "## ðŸ“Š Workflow Performance Report" >> performance-report.md
          echo "" >> performance-report.md
          echo "| Workflow | Avg Duration | Success Rate | Last 7 Days Runs |" >> performance-report.md
          echo "|----------|--------------|--------------|------------------|" >> performance-report.md

          # Analyze CodeQL workflow
          CODEQL_RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/codeql.yml/runs \
            --jq '.workflow_runs[0:10] | map(select(.created_at > (now - 30*24*3600 | todate))) | length')
          CODEQL_SUCCESS=$(gh api repos/${{ github.repository }}/actions/workflows/codeql.yml/runs \
            --jq '.workflow_runs[0:10] | map(select(.created_at > (now - 30*24*3600 | todate) and .conclusion == "success")) | length')
          CODEQL_AVG_DURATION=$(gh api repos/${{ github.repository }}/actions/workflows/codeql.yml/runs \
            --jq '.workflow_runs[0:5] | map(select(.conclusion == "success")) | map((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) | add / length | floor')

          if [ "$CODEQL_RUNS" -gt 0 ]; then
            CODEQL_SUCCESS_RATE=$(echo "scale=1; $CODEQL_SUCCESS * 100 / $CODEQL_RUNS" | bc -l)
            CODEQL_DURATION_MIN=$(echo "scale=1; $CODEQL_AVG_DURATION / 60" | bc -l)
            echo "| CodeQL Security Analysis | ${CODEQL_DURATION_MIN}min | ${CODEQL_SUCCESS_RATE}% | $CODEQL_RUNS |" >> performance-report.md
          fi

          # Analyze MegaLinter workflow
          MEGALINTER_RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/security-scan.yml/runs \
            --jq '.workflow_runs[0:10] | map(select(.created_at > (now - 30*24*3600 | todate))) | length')
          MEGALINTER_SUCCESS=$(gh api repos/${{ github.repository }}/actions/workflows/security-scan.yml/runs \
            --jq '.workflow_runs[0:10] | map(select(.created_at > (now - 30*24*3600 | todate) and .conclusion == "success")) | length')
          MEGALINTER_AVG_DURATION=$(gh api repos/${{ github.repository }}/actions/workflows/security-scan.yml/runs \
            --jq '.workflow_runs[0:5] | map(select(.conclusion == "success")) | map((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) | add / length | floor')

          if [ "$MEGALINTER_RUNS" -gt 0 ]; then
            MEGALINTER_SUCCESS_RATE=$(echo "scale=1; $MEGALINTER_SUCCESS * 100 / $MEGALINTER_RUNS" | bc -l)
            MEGALINTER_DURATION_MIN=$(echo "scale=1; $MEGALINTER_AVG_DURATION / 60" | bc -l)
            echo "| MegaLinter Security Scan | ${MEGALINTER_DURATION_MIN}min | ${MEGALINTER_SUCCESS_RATE}% | $MEGALINTER_RUNS |" >> performance-report.md
          fi

          echo "" >> performance-report.md
          echo "### ðŸ”§ Optimization Recommendations" >> performance-report.md
          echo "" >> performance-report.md

          # Check for optimization opportunities
          if [ "$CODEQL_AVG_DURATION" -gt 1800 ]; then
            echo "- âš ï¸  CodeQL analysis taking longer than 30 minutes - consider optimizing queries" >> performance-report.md
          fi

          if [ "$MEGALINTER_AVG_DURATION" -gt 3600 ]; then
            echo "- âš ï¸  MegaLinter scan taking longer than 60 minutes - consider flavor optimization" >> performance-report.md
          fi

          # Check success rates
          if [ "$CODEQL_RUNS" -gt 0 ] && [ "$(echo "$CODEQL_SUCCESS_RATE < 90" | bc -l)" = "1" ]; then
            echo "- âŒ CodeQL success rate below 90% - investigate failure patterns" >> performance-report.md
          fi

          if [ "$MEGALINTER_RUNS" -gt 0 ] && [ "$(echo "$MEGALINTER_SUCCESS_RATE < 90" | bc -l)" = "1" ]; then
            echo "- âŒ MegaLinter success rate below 90% - investigate failure patterns" >> performance-report.md
          fi

          echo "" >> performance-report.md
          echo "Generated on: $(date -u)" >> performance-report.md

      - name: Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-performance-report
          path: performance-report.md
          retention-days: 90

      - name: Create Workflow Summary
        if: always()
        run: |
          if [ -f performance-report.md ]; then
            cat performance-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Performance Report Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Unable to generate performance metrics. Check workflow permissions and GitHub API access." >> $GITHUB_STEP_SUMMARY
          fi

  resource-usage:
    name: Resource Usage Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Analyze Repository Size and Complexity
        run: |
          echo "## ðŸ“ Repository Metrics" >> resource-analysis.md
          echo "" >> resource-analysis.md
          echo "| Metric | Value |" >> resource-analysis.md
          echo "|--------|-------|" >> resource-analysis.md

          # Repository size
          REPO_SIZE=$(du -sh . | cut -f1)
          echo "| Repository Size | $REPO_SIZE |" >> resource-analysis.md

          # File counts
          TOTAL_FILES=$(find . -type f ! -path "./.git/*" | wc -l)
          echo "| Total Files | $TOTAL_FILES |" >> resource-analysis.md

          # JavaScript files
          JS_FILES=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | wc -l)
          echo "| JavaScript/TypeScript Files | $JS_FILES |" >> resource-analysis.md

          # Configuration files
          CONFIG_FILES=$(find . -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.toml" | wc -l)
          echo "| Configuration Files | $CONFIG_FILES |" >> resource-analysis.md

          # Workflow files
          WORKFLOW_FILES=$(find .github/workflows -name "*.yml" 2>/dev/null | wc -l)
          echo "| Workflow Files | $WORKFLOW_FILES |" >> resource-analysis.md

          echo "" >> resource-analysis.md
          echo "### ðŸ’¡ Resource Optimization Suggestions" >> resource-analysis.md
          echo "" >> resource-analysis.md

          # Optimization suggestions based on metrics
          if [ "$TOTAL_FILES" -gt 1000 ]; then
            echo "- Consider using path filters in workflows to scan only changed files" >> resource-analysis.md
          fi

          if [ "$WORKFLOW_FILES" -gt 5 ]; then
            echo "- Consider consolidating similar workflows to reduce complexity" >> resource-analysis.md
          fi

          echo "- Use caching strategies for dependencies to improve workflow performance" >> resource-analysis.md
          echo "- Consider running heavy scans only on schedule rather than every push" >> resource-analysis.md

      - name: Upload Resource Analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resource-usage-analysis
          path: resource-analysis.md
          retention-days: 30